#!/bin/sh
# subnet-config - Generate system config files for IPv6 ULA subnet authority
# Usage: subnet-config [-c config] [-o output_dir] <generate|check|copy|apply>
#
# Note: Uses `local` which, while not in POSIX, is supported by all common
# /bin/sh implementations (bash, dash, ash, zsh, mksh, busybox sh).

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/subnet.conf"
OUTPUT_DIR="."

# Config variables (set by parse_ini)
authority_interface=""
authority_prefix=""
authority_address=""
authority_address_bare=""
authority_zone=""
radvd_adv_autonomous="true"
radvd_adv_managed="false"
radvd_adv_other="false"
radvd_rdnss="true"
dns_upstream=""

# --- Helpers ---

error() {
    printf "Error: %s\n" "$1" >&2
    exit 1
}

# Normalize a boolean config value. Sets the named variable to "true" or "false".
normalize_bool() {
    case "$2" in
        true|yes|1) eval "$1=true" ;;
        false|no|0) eval "$1=false" ;;
        *) error "Invalid boolean for $1: $2" ;;
    esac
}

# Strip CIDR prefix length from an address (e.g. "fd00::1/64" -> "fd00::1")
strip_prefix_len() {
    printf '%s' "$1" | sed 's|/.*||'
}

# --- INI parser ---

parse_ini() {
    local config="$1"
    local section="" line key value

    [ -f "$config" ] || error "Config file not found: $config"

    while IFS= read -r line || [ -n "$line" ]; do
        line="$(printf '%s' "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

        case "$line" in
            ''|'#'*) continue ;;
        esac

        # Section header
        if printf '%s' "$line" | grep -q '^\[.*\]$'; then
            section="$(printf '%s' "$line" | sed 's/^\[\(.*\)\]$/\1/')"
            continue
        fi

        # Key = value
        if printf '%s' "$line" | grep -q '='; then
            key="$(printf '%s' "$line" | sed 's/[[:space:]]*=.*//')"
            value="$(printf '%s' "$line" | sed 's/^[^=]*=[[:space:]]*//' | sed 's/[[:space:]]*#.*$//' | sed 's/[[:space:]]*$//')"

            # Reject keys that aren't valid identifiers
            case "$key" in
                *[!a-zA-Z0-9_]*) error "Invalid config key: $key" ;;
            esac

            case "$section" in
                authority) eval "authority_$key=\"\$value\"" ;;
                radvd) eval "radvd_$key=\"\$value\"" ;;
                dns) eval "dns_$key=\"\$value\"" ;;
            esac
        fi
    done < "$config"
}

# --- Validation ---

validate_config() {
    [ -n "$authority_interface" ] || error "Missing required field: authority.interface"
    [ -n "$authority_prefix" ] || error "Missing required field: authority.prefix"
    [ -n "$authority_address" ] || error "Missing required field: authority.address"
    [ -n "$authority_zone" ] || error "Missing required field: authority.zone"

    printf '%s' "$authority_prefix" | grep -q '^fd[0-9a-f]\{2\}:[0-9a-f:]*/..*$' || \
        error "Invalid IPv6 ULA prefix format: $authority_prefix"

    authority_address_bare="$(strip_prefix_len "$authority_address")"

    normalize_bool radvd_adv_autonomous "$radvd_adv_autonomous"
    normalize_bool radvd_adv_managed "$radvd_adv_managed"
    normalize_bool radvd_adv_other "$radvd_adv_other"
    normalize_bool radvd_rdnss "$radvd_rdnss"
}

# --- File mapping ---
#
# Central registry of (generated_basename, system_path) pairs.
# Calls "$1 <basename> <system_path>" for each output file.

for_each_output() {
    local callback="$1"
    local iface

    "$callback" "radvd.conf" "/etc/radvd.conf"
    for iface in $authority_interface; do
        "$callback" "50-subnet-authority-$iface.network" \
            "/etc/systemd/network/50-subnet-authority-$iface.network"
    done
    "$callback" "subnet-authority.conf" "/etc/dnsmasq.d/subnet-authority.conf"
}

# --- Generators ---

generate_radvd() {
    local output="$OUTPUT_DIR/radvd.conf"
    local iface

    {
        printf "# Generated by subnet-config — do not edit manually\n\n"

        for iface in $authority_interface; do
            printf "interface %s {\n" "$iface"
            printf "    AdvSendAdvert on;\n"
            printf "    AdvManagedFlag %s;\n" "$radvd_adv_managed"
            printf "    AdvOtherConfigFlag %s;\n\n" "$radvd_adv_other"

            printf "    prefix %s {\n" "$authority_prefix"
            printf "        AdvOnLink on;\n"
            printf "        AdvAutonomous %s;\n" "$radvd_adv_autonomous"
            printf "    };\n"

            if [ "$radvd_rdnss" = "true" ]; then
                printf "\n    RDNSS %s {\n" "$authority_address_bare"
                printf "    };\n"
            fi

            printf "};\n\n"
        done
    } > "$output"

    printf "Generated: %s\n" "$output"
}

generate_networkd() {
    local iface output

    for iface in $authority_interface; do
        output="$OUTPUT_DIR/50-subnet-authority-$iface.network"

        {
            printf "# Generated by subnet-config — do not edit manually\n\n"
            printf "[Match]\n"
            printf "Name=%s\n\n" "$iface"
            printf "[Network]\n"
            printf "Address=%s\n" "$authority_address"
            printf "IPv6AcceptRA=no\n"
        } > "$output"

        printf "Generated: %s\n" "$output"
    done
}

generate_dnsmasq() {
    local output="$OUTPUT_DIR/subnet-authority.conf"
    local server

    {
        printf "# Generated by subnet-config — do not edit manually\n\n"
        printf "# Listen on authority address\n"
        printf "listen-address=%s\n\n" "$authority_address_bare"

        printf "# Authority zone\n"
        printf "auth-zone=%s,%s\n\n" "$authority_zone" "$authority_prefix"

        if [ -n "$dns_upstream" ]; then
            printf "# Upstream DNS servers\n"
            for server in $dns_upstream; do
                printf "server=%s\n" "$server"
            done
        fi
    } > "$output"

    printf "Generated: %s\n" "$output"
}

# --- Subcommand helpers ---

HAVE_DIFFS=0

check_file() {
    local generated="$OUTPUT_DIR/$1"
    local system="$2"

    if [ ! -f "$generated" ]; then
        error "Generated file not found: $generated (run 'generate' first)"
    fi

    printf "Checking: %s vs %s\n" "$generated" "$system"
    if [ ! -f "$system" ]; then
        printf "  System file does not exist\n"
        HAVE_DIFFS=1
    elif ! diff -u "$system" "$generated" > /dev/null 2>&1; then
        diff -u "$system" "$generated" || true
        HAVE_DIFFS=1
    else
        printf "  No changes\n"
    fi
}

copy_file() {
    local generated="$OUTPUT_DIR/$1"
    local system="$2"
    local target_dir

    [ -f "$generated" ] || error "Generated file not found: $generated (run 'generate' first)"

    target_dir="$(dirname "$system")"
    [ -d "$target_dir" ] || mkdir -p "$target_dir"

    printf "Copying: %s -> %s\n" "$generated" "$system"
    cp "$generated" "$system" || error "Failed to copy to $system (try with sudo?)"
}

# --- Subcommands ---

cmd_generate() {
    parse_ini "$CONFIG_FILE"
    validate_config

    [ -d "$OUTPUT_DIR" ] || mkdir -p "$OUTPUT_DIR"

    generate_radvd
    generate_networkd
    generate_dnsmasq

    printf "\nGeneration complete. Files written to: %s\n" "$OUTPUT_DIR"
}

cmd_check() {
    parse_ini "$CONFIG_FILE"
    validate_config
    HAVE_DIFFS=0

    for_each_output check_file

    if [ "$HAVE_DIFFS" -eq 0 ]; then
        printf "\nAll system files match generated files.\n"
    else
        printf "\nSome system files differ from generated files.\n"
        return 1
    fi
}

cmd_copy() {
    parse_ini "$CONFIG_FILE"
    validate_config

    for_each_output copy_file

    printf "\nAll files copied successfully.\n"
}

cmd_apply() {
    printf "Restarting daemons...\n"

    systemctl restart radvd || error "Failed to restart radvd"
    printf "  radvd restarted\n"

    systemctl restart systemd-networkd || error "Failed to restart systemd-networkd"
    printf "  systemd-networkd restarted\n"

    systemctl restart dnsmasq || error "Failed to restart dnsmasq"
    printf "  dnsmasq restarted\n"

    printf "\nAll daemons restarted successfully.\n"
}

# --- Main ---

usage() {
    printf "Usage: %s [-c config] [-o output_dir] <generate|check|copy|apply>\n" "$(basename "$0")"
    printf "\nSubcommands:\n"
    printf "  generate  Generate config files to output directory\n"
    printf "  check     Compare generated files with system files\n"
    printf "  copy      Copy generated files to system locations\n"
    printf "  apply     Restart affected daemons\n"
    printf "\nOptions:\n"
    printf "  -c <path>  Config file (default: subnet.conf in script directory)\n"
    printf "  -o <dir>   Output directory for generated files (default: current directory)\n"
    exit 1
}

while getopts "c:o:h" opt; do
    case "$opt" in
        c) CONFIG_FILE="$OPTARG" ;;
        o) OUTPUT_DIR="$OPTARG" ;;
        h) usage ;;
        *) usage ;;
    esac
done

shift $((OPTIND - 1))

[ $# -eq 0 ] && usage

case "$1" in
    generate) cmd_generate ;;
    check) cmd_check ;;
    copy) cmd_copy ;;
    apply) cmd_apply ;;
    *) error "Unknown subcommand: $1" ;;
esac
